<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.greatway.dao.InsframeworkMapper">

	<resultMap id="insMap" type="com.greatway.model.Insframework">
		<id property="id" column="fid"></id> 
            <result property="name" column="fname"></result>  
            <result property="logogram" column="flogogram"></result>  
            <result property="code" column="fcode"></result>
        	<result property="parent" column="fparent"></result>
        	<result property="type" column="ftype"></result>
	</resultMap>
	
	<select id="getInsframeworkAll" resultMap="insMap">
		SELECT i.fid,i.fname,i.flogogram,i.fcode,i.fparent,i.ftype FROM tb_insframework i
		<choose>
			<when test="dto!=null and dto!='' and parent!=null and parent!=''">
				INNER JOIN tb_insframework ins ON ins.fid = i.fparent 
				where 1=1
				<if test="dto.bloc!=null and dto.bloc!=''">
					and i.ftype != 20
				</if>
				<if test="dto.company!=null and dto.company!=''">
					 and ( ins.fid=#{parent} or ins.fparent=#{parent} )
				</if>
				<if test="dto.caust!=null and dto.caust!=''">
					 and ins.fid=#{parent} 
				</if>
				<if test="dto.item!=null and dto.item!=''">
					 and i.fid=#{parent} 
				</if>
			</when>
			<otherwise>
				where 1=1
			</otherwise>
		</choose>
		<if test="str!=null and str!=''">
			and ${str}
		</if>
	</select>
	
	<select id="getInsframework" resultMap="insMap">
		SELECT fid,fname,flogogram,fcode,fparent,ftype FROM tb_insframework where  ftype>22
	</select>
	
	<select id="getParent" resultMap="insMap">
		SELECT ins.fid, ins.fname
		FROM tb_insframework i
		inner JOIN tb_insframework ins ON i.fparent = ins.fid
		WHERE i.fid =#{id}
	</select>
	
	<!-- 查看集团 -->
	<select id="getBloc" resultMap="insMap">
		SELECT fid,fname FROM tb_insframework WHERE ftype=20
	</select>
	
	<!-- 查看公司级 -->
	<select id="getConmpany" resultMap="insMap">
		SELECT fid,fname FROM tb_insframework WHERE ftype=21
	</select>
	
	<!-- 查看事业部级 -->
	<select id="getCause" resultMap="insMap">
		SELECT fid,fname FROM tb_insframework WHERE fparent = #{id}
	</select>
	
	<!-- 获取用户所属层级 -->
	<select id="getUserInsfType" resultType="java.lang.Integer">
		SELECT ftype from tb_users u
		inner join tb_insframework i	on u.users_insframework=i.fid	where id=#{uid}
	</select>
	
	<!-- 获取用户所属事业部所拥有的项目部 -->
	<select id="getUserInsfId" resultType="java.math.BigInteger">
		SELECT fid from tb_users u
		inner join tb_insframework i	on u.users_insframework=i.fid	where id=#{uid} 
	</select>
	
	<select id="getInsframeworkByName" resultType="java.math.BigInteger">
		select fid from tb_insframework where fname = #{name}
	</select>
	
	<select id="getInsframeworkById" resultType="java.lang.String">
		select fname from tb_insframework where fid = #{id}
	</select>
	
	<select id="getInsfAllById" resultMap="insMap">
		select * from tb_insframework where fid = #{id}
	</select>
	
	<select id="getInsframeworkNameCount" resultType="java.lang.Integer">
		select count(*) from tb_insframework where fname=#{name}
	</select>
	
	<select id="getTypeById" resultType="java.lang.Integer">
		SELECT ftype FROM tb_insframework  where fid= #{id}
	</select>
	
	<select id="getParentById" resultType="java.math.BigInteger">
		SELECT fparent FROM tb_insframework  where fid= #{id}
	</select>
	
	<select id="getInsByType" resultMap="insMap">
		select i.fid,i.fname from tb_insframework i
		inner join tb_insframework ins on ins.fid = i.fparent 
		where i.ftype=#{type}
		<if test="parent!=null and parent!=''">
			and (i.fparent = #{parent} or ins.fparent = #{parent})
		</if>
	</select>
	
	<insert id="addInsframework" parameterType="com.greatway.model.Insframework" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tb_insframework(fname, flogogram, fcode, fparent, ftype) VALUES (#{name},#{logogram},#{code},#{parent},#{type})
 	</insert>
	
	<update id="editInsframework" parameterType="com.greatway.model.Insframework">
		UPDATE tb_insframework SET fname=#{name},flogogram=#{logogram},fcode=#{code},fparent=#{parent},ftype=#{type} WHERE fid=#{id}
	</update>
	
	<delete id="deleteInsframework" parameterType="java.math.BigInteger">
		DELETE FROM tb_insframework WHERE fid=#{id}
	</delete>
	
</mapper>
